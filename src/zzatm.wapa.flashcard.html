<%@page language="abap" %>                                                                                                                                                                                                                                     
<!doctype html>                                                                                                                                                                                                                                                
<html lang="en">                                                                                                                                                                                                                                               
<head>                                                                                                                                                                                                                                                         
  <meta charset="utf-8">                                                                                                                                                                                                                                       
  <title>ABAP Teachable Machine Game</title>                                                                                                                                                                                                                   
  <meta name="description" content="ABAP Teachable Machine Game">                                                                                                                                                                                              
  <meta name="author" content="Alban Leong">                                                                                                                                                                                                                   
  <meta name="license" content="MIT License">                                                                                                                                                                                                                  
  <link rel="stylesheet" href="./css/materialize.min.css">                                                                                                                                                                                                     
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">                                                                                                                                                                       
</head>                                                                                                                                                                                                                                                        
<body>                                                                                                                                                                                                                                                         
  <nav class="blue lighten-4">                                                                                                                                                                                                                                 
    <div class="nav-wrapper container blue lighten-4">                                                                                                                                                                                                         
      <span class="black-text brand-logo center">Flash Card Game</span>                                                                                                                                                                                        
      <ul id="nav-mobile" class="left hide-on-med-and-down">                                                                                                                                                                                                   
        <li><a href="index.html" class="black-text"><i class="material-icons right">people</i></a></li>                                                                                                                                                        
      </ul>                                                                                                                                                                                                                                                    
    </div>                                                                                                                                                                                                                                                     
  </nav>                                                                                                                                                                                                                                                       
  <br /><br />                                                                                                                                                                                                                                                 
<%                                                                                                                                                                                                                                                             
  if player is not initial.                                                                                                                                                                                                                                    
  if player-gsound is not initial.  " game background sound                                                                                                                                                                                                    
%>                                                                                                                                                                                                                                                             
<audio loop src="<%= player-gsound%>" id="background-sound"></audio>                                                                                                                                                                                           
<%                                                                                                                                                                                                                                                             
  endif.                                                                                                                                                                                                                                                       
  if player-esound is not initial.  " game end sound                                                                                                                                                                                                           
%>                                                                                                                                                                                                                                                             
<audio src="<%= player-esound%>" id="game-end-sound"></audio>                                                                                                                                                                                                  
<%                                                                                                                                                                                                                                                             
  endif.                                                                                                                                                                                                                                                       
  if player-csound is not initial.  " correct answer sound                                                                                                                                                                                                     
%>                                                                                                                                                                                                                                                             
<audio src="<%= player-csound%>" id="correct-answer-sound"></audio>                                                                                                                                                                                            
<%                                                                                                                                                                                                                                                             
  endif.                                                                                                                                                                                                                                                       
  endif. " player check                                                                                                                                                                                                                                        
  " Check to see if there are any questions set up for this player + game...                                                                                                                                                                                   
  if questions[] is not initial.                                                                                                                                                                                                                               
%>                                                                                                                                                                                                                                                             
<div class="container">                                                                                                                                                                                                                                        
<div class="row">                                                                                                                                                                                                                                              
  <div class="progress red" id="timer-progress-bar">                                                                                                                                                                                                           
      <div class="determinate" style="width: 100%" id="timer-bar"></div>                                                                                                                                                                                       
  </div>                                                                                                                                                                                                                                                       
  <div class="col s4 offset-s4">                                                                                                                                                                                                                               
    <div class="card scale-transition scale-out" id="flash-card">                                                                                                                                                                                              
      <div class="card-image img-responsive">                                                                                                                                                                                                                  
        <img src="" id="flash-card-img">                                                                                                                                                                                                                       
      </div>                                                                                                                                                                                                                                                   
    </div>                                                                                                                                                                                                                                                     
    <div class="card-panel blue lighten-5 scale-transition scale-out" id="end-message">                                                                                                                                                                        
      <span class="black-text" align="center">Well done! Thanks for playing. <br /><br />                                                                                                                                                                      
      <a class="waves-effect waves-light btn blue darken-4">select another game</a> or <a class="waves-effect waves-light btn blue darken-4">Play again</a></span>                                                                                             
    </div>                                                                                                                                                                                                                                                     
  </div>                                                                                                                                                                                                                                                       
</div>                                                                                                                                                                                                                                                         
<div class="row" id="questions-chips">                                                                                                                                                                                                                         
<%                                                                                                                                                                                                                                                             
    data(count) = lines( questions ).                                                                                                                                                                                                                          
    do count times.                                                                                                                                                                                                                                            
      data(array_index) = sy-index - 1.                                                                                                                                                                                                                        
%>                                                                                                                                                                                                                                                             
    <div class="chip" id="chip-<%= array_index%>"><%= sy-index%></div>                                                                                                                                                                                         
<%                                                                                                                                                                                                                                                             
    enddo.                                                                                                                                                                                                                                                     
%>                                                                                                                                                                                                                                                             
</div>                                                                                                                                                                                                                                                         
</div>                                                                                                                                                                                                                                                         
<%                                                                                                                                                                                                                                                             
  " No questions found - display message to set up new questions in transaction ZZATMSETUP                                                                                                                                                                     
  else.                                                                                                                                                                                                                                                        
%>                                                                                                                                                                                                                                                             
<div class="section no-pad-bot" id="index-banner">                                                                                                                                                                                                             
  <div class="container">                                                                                                                                                                                                                                      
    <br /><br />                                                                                                                                                                                                                                               
    <h1 class="header center amber-text">No questions found...</h1>                                                                                                                                                                                            
    <div class="row center">                                                                                                                                                                                                                                   
      <h5 class="header col s12 light">Run transaction ZZATMSETUP to set up questions!</h5>                                                                                                                                                                    
    </div>                                                                                                                                                                                                                                                     
    <br /><br />                                                                                                                                                                                                                                               
  </div>                                                                                                                                                                                                                                                       
</div>                                                                                                                                                                                                                                                         
<%                                                                                                                                                                                                                                                             
  endif. " End questions display                                                                                                                                                                                                                               
%>                                                                                                                                                                                                                                                             
<%                                                                                                                                                                                                                                                             
  if player-gsound is not initial.                                                                                                                                                                                                                             
%>                                                                                                                                                                                                                                                             
<div class="fixed-action-btn">                                                                                                                                                                                                                                 
  <a class="btn-floating btn-large deep-orange lighten-2">                                                                                                                                                                                                     
    <i class="large material-icons">audiotrack</i>                                                                                                                                                                                                             
  </a>                                                                                                                                                                                                                                                         
  <ul>                                                                                                                                                                                                                                                         
    <li><a class="btn-floating red" href="#" id="music-stop-btn"><i class="material-icons">stop</i></a></li>                                                                                                                                                   
    <li><a class="btn-floating green"  href="#" id="music-start-btn"><i class="material-icons">play_arrow</i></a></li>                                                                                                                                         
  </ul>                                                                                                                                                                                                                                                        
</div>                                                                                                                                                                                                                                                         
<%                                                                                                                                                                                                                                                             
  endif. " Background game sound control                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
  if player-debug is not initial.                                                                                                                                                                                                                              
%>                                                                                                                                                                                                                                                             
  <div class="container row">                                                                                                                                                                                                                                  
    <div id="label-container"></div>                                                                                                                                                                                                                           
  </div>                                                                                                                                                                                                                                                       
<%                                                                                                                                                                                                                                                             
  endif. " player debug                                                                                                                                                                                                                                        
%>                                                                                                                                                                                                                                                             
<br /><br />                                                                                                                                                                                                                                                   
<footer class="page-footer blue lighten-3">                                                                                                                                                                                                                    
  <div class="container">                                                                                                                                                                                                                                      
    <div class="row">                                                                                                                                                                                                                                          
      <div class="col s12">                                                                                                                                                                                                                                    
        <h6 class="white-text" align="center">Best played with headphones on.</h6>                                                                                                                                                                             
      </div>                                                                                                                                                                                                                                                   
    </div>                                                                                                                                                                                                                                                     
  </div>                                                                                                                                                                                                                                                       
  <div class="footer-copyright blue darken-4">                                                                                                                                                                                                                 
    <div class="container">                                                                                                                                                                                                                                    
    <a href="license.html" class="white-text">MIT License</a> | <a href="credits.html" class="white-text">Credits</a>                                                                                                                                          
    <span class="right white-text">                                                                                                                                                                                                                            
    Developed with &hearts; in ABAP by Alban Leong.<br /> Powered by <a class="grey-text text-lighten-4" href="https://www.sap.com/products/netweaver-platform.html">SAP NetWeaver</a> and                                                                     
    <a class="grey-text text-lighten-4" href="https://teachablemachine.withgoogle.com/">Teachable Machine</a>.                                                                                                                                                 
    </span>                                                                                                                                                                                                                                                    
    </div>                                                                                                                                                                                                                                                     
  </div>                                                                                                                                                                                                                                                       
</footer>                                                                                                                                                                                                                                                      
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>                                                                                                                                                                     
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.4.0/dist/speech-commands.min.js"></script>                                                                                                                                      
<script src="./js/materialize.min.js"></script>                                                                                                                                                                                                                
<script type="text/javascript">                                                                                                                                                                                                                                
  function remove_flash_card(gameCard) {                                                                                                                                                                                                                       
    gameCard.classList.remove("scale-in");                                                                                                                                                                                                                     
    // reset the timer bar to 100% as well                                                                                                                                                                                                                     
    var timerBar = document.getElementById("timer-bar");                                                                                                                                                                                                       
    timerBar.setAttribute("style", "width: 100%");                                                                                                                                                                                                             
  }                                                                                                                                                                                                                                                            
  function loopQuestions(callback, time, iteration, currentIteration){                                                                                                                                                                                         
      if(typeof currentIteration === 'undefined' || isNaN(currentIteration)) currentIteration = 0;                                                                                                                                                             
      if(iteration){                                                                                                                                                                                                                                           
          if(currentIteration === 0){                                                                                                                                                                                                                          
            callback.call(this, currentIteration);                                                                                                                                                                                                             
            loopQuestions(callback, time, iteration - 1, currentIteration + 1);                                                                                                                                                                                
          } else {                                                                                                                                                                                                                                             
            setTimeout(function(){                                                                                                                                                                                                                             
                callback.call(this, currentIteration);                                                                                                                                                                                                         
                loopQuestions(callback, time, iteration - 1, currentIteration + 1);                                                                                                                                                                            
            }, time);                                                                                                                                                                                                                                          
          }                                                                                                                                                                                                                                                    
      }                                                                                                                                                                                                                                                        
  }                                                                                                                                                                                                                                                            
  function shuffle(array) {                                                                                                                                                                                                                                    
    let currentIndex = array.length, temporaryValue, randomIndex;                                                                                                                                                                                              
    // While there remain elements to shuffle...                                                                                                                                                                                                               
    while (0 !== currentIndex) {                                                                                                                                                                                                                               
      // Pick a remaining element...                                                                                                                                                                                                                           
      randomIndex = Math.floor(Math.random() * currentIndex);                                                                                                                                                                                                  
      currentIndex -= 1;                                                                                                                                                                                                                                       
      // And swap it with the current element.                                                                                                                                                                                                                 
      temporaryValue = array[currentIndex];                                                                                                                                                                                                                    
      array[currentIndex] = array[randomIndex];                                                                                                                                                                                                                
      array[randomIndex] = temporaryValue;                                                                                                                                                                                                                     
    }                                                                                                                                                                                                                                                          
    return array;                                                                                                                                                                                                                                              
  }                                                                                                                                                                                                                                                            
  document.addEventListener('DOMContentLoaded', function(event) {                                                                                                                                                                                              
    // get list of questions in JSON format                                                                                                                                                                                                                    
    const questions = <%= questions_json %>;                                                                                                                                                                                                                   
    shuffle(questions);  // shuffle the questions so that it becomes sort of random                                                                                                                                                                            
    // set URL of Teachable Machine model from config                                                                                                                                                                                                          
    const modelURL = "<%= game-model%>";                                                                                                                                                                                                                       
    // get games delay                                                                                                                                                                                                                                         
    const gameStartDelay = <%= game-start_delay%>;                                                                                                                                                                                                             
    const gameNextDelay  = <%= game-next_delay%>                                                                                                                                                                                                               
    // play and set game background music controls                                                                                                                                                                                                             
<%                                                                                                                                                                                                                                                             
  if player-gsound is not initial.                                                                                                                                                                                                                             
%>                                                                                                                                                                                                                                                             
const bgmusic = document.getElementById("background-sound");                                                                                                                                                                                                   
bgmusic.volume = 0.2;                                                                                                                                                                                                                                          
bgmusic.play();                                                                                                                                                                                                                                                
let start_btn = document.getElementById("music-start-btn");                                                                                                                                                                                                    
let stop_btn = document.getElementById("music-stop-btn");                                                                                                                                                                                                      
start_btn.onclick = function() {                                                                                                                                                                                                                               
  const playmusic = document.getElementById("background-sound");                                                                                                                                                                                               
  playmusic.volume = 0.2;                                                                                                                                                                                                                                      
  playmusic.play();                                                                                                                                                                                                                                            
  return false;                                                                                                                                                                                                                                                
}                                                                                                                                                                                                                                                              
stop_btn.onclick = function() {                                                                                                                                                                                                                                
  const stopmusic = document.getElementById("background-sound");                                                                                                                                                                                               
  stopmusic.pause();                                                                                                                                                                                                                                           
  return false;                                                                                                                                                                                                                                                
}                                                                                                                                                                                                                                                              
// background music control                                                                                                                                                                                                                                    
let elems = document.querySelectorAll('.fixed-action-btn');                                                                                                                                                                                                    
let instances = M.FloatingActionButton.init(elems, {                                                                                                                                                                                                           
direction: 'top'                                                                                                                                                                                                                                               
});                                                                                                                                                                                                                                                            
<%                                                                                                                                                                                                                                                             
  endif.                                                                                                                                                                                                                                                       
%>                                                                                                                                                                                                                                                             
    // get recognizer for teachable machine                                                                                                                                                                                                                    
    async function createModel() {                                                                                                                                                                                                                             
        const checkpointURL = modelURL + "model.json"; // model topology                                                                                                                                                                                       
        const metadataURL = modelURL + "metadata.json"; // model metadata                                                                                                                                                                                      
        const recognizer = speechCommands.create(                                                                                                                                                                                                              
            "BROWSER_FFT", // fourier transform type, not useful to change                                                                                                                                                                                     
            undefined, // speech commands vocabulary feature, not useful for your models                                                                                                                                                                       
            checkpointURL,                                                                                                                                                                                                                                     
            metadataURL);                                                                                                                                                                                                                                      
        // check that model and metadata are loaded via HTTPS requests.                                                                                                                                                                                        
        await recognizer.ensureModelLoaded();                                                                                                                                                                                                                  
        return recognizer;                                                                                                                                                                                                                                     
    }                                                                                                                                                                                                                                                          
    async function init() {                                                                                                                                                                                                                                    
      let scores;                                                                                                                                                                                                                                              
      let correctAnswers;                                                                                                                                                                                                                                      
      const recognizer = await createModel();                                                                                                                                                                                                                  
<%                                                                                                                                                                                                                                                             
  if player-debug is not initial.                                                                                                                                                                                                                              
%>                                                                                                                                                                                                                                                             
      const classLabels = recognizer.wordLabels(); // get class labels                                                                                                                                                                                         
      const labelContainer = document.getElementById("label-container");                                                                                                                                                                                       
      for (let i = 0; i < classLabels.length; i++) {                                                                                                                                                                                                           
          labelContainer.appendChild(document.createElement("div"));                                                                                                                                                                                           
      }                                                                                                                                                                                                                                                        
<%                                                                                                                                                                                                                                                             
  endif.                                                                                                                                                                                                                                                       
%>                                                                                                                                                                                                                                                             
      // listen() takes two arguments:                                                                                                                                                                                                                         
      // 1. A callback function that is invoked anytime a word is recognized.                                                                                                                                                                                  
      // 2. A configuration object with adjustable fields                                                                                                                                                                                                      
      recognizer.listen(result => {                                                                                                                                                                                                                            
          scores = result.scores; // probability of prediction for each class                                                                                                                                                                                  
<%                                                                                                                                                                                                                                                             
  if player-debug is not initial.                                                                                                                                                                                                                              
%>                                                                                                                                                                                                                                                             
          // render the probability scores per class                                                                                                                                                                                                           
          for (let i = 0; i < classLabels.length; i++) {                                                                                                                                                                                                       
              const classPrediction = classLabels[i] + ": " + result.scores[i].toFixed(2);                                                                                                                                                                     
              labelContainer.childNodes[i].innerHTML = classPrediction;                                                                                                                                                                                        
          }                                                                                                                                                                                                                                                    
<%                                                                                                                                                                                                                                                             
  endif.                                                                                                                                                                                                                                                       
%>                                                                                                                                                                                                                                                             
      }, {                                                                                                                                                                                                                                                     
          includeSpectrogram: true, // in case listen should return result.spectrogram                                                                                                                                                                         
          probabilityThreshold: 0.75,                                                                                                                                                                                                                          
          invokeCallbackOnNoiseAndUnknown: true,                                                                                                                                                                                                               
          overlapFactor: 0.50 // probably want between 0.5 and 0.75. More info in README                                                                                                                                                                       
      });                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
      // loop at the questions...                                                                                                                                                                                                                              
      loopQuestions(function(i){                                                                                                                                                                                                                               
          // set the image to the flash card                                                                                                                                                                                                                   
          let cardImage = document.getElementById("flash-card-img");                                                                                                                                                                                           
          cardImage.setAttribute("src", questions[i].imageUrl);                                                                                                                                                                                                
          // show the flash card                                                                                                                                                                                                                               
          let gameCard = document.getElementById("flash-card");                                                                                                                                                                                                
          gameCard.classList.add("scale-in");                                                                                                                                                                                                                  
          // update the remaining time progress bar every .1 seconds (smooth)                                                                                                                                                                                  
          var time = ((gameNextDelay)*10);                                                                                                                                                                                                                     
          var timer = setInterval(function() {                                                                                                                                                                                                                 
             if(scores){                                                                                                                                                                                                                                       
               var score = scores[questions[i].arrayIdx].toFixed(2);                                                                                                                                                                                           
               if(score>=<%= game-prob_match %>){                                                                                                                                                                                                              
                 const playCorrect = document.getElementById("correct-answer-sound");                                                                                                                                                                          
                 if(playCorrect){                                                                                                                                                                                                                              
                   playCorrect.volume = 0.5;                                                                                                                                                                                                                   
                   playCorrect.play();                                                                                                                                                                                                                         
                 }                                                                                                                                                                                                                                             
                 // mark the question chip with green color                                                                                                                                                                                                    
                 let chipCounter = 'chip-' + i + ' ';                                                                                                                                                                                                          
                 let chipCard = document.getElementById(chipCounter);                                                                                                                                                                                          
                 if(chipCard){ chipCard.classList.add("green"); }                                                                                                                                                                                              
               }                                                                                                                                                                                                                                               
             }                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
             var timerBar = document.getElementById("timer-bar");                                                                                                                                                                                              
             time--;                                                                                                                                                                                                                                           
             if (time!=0) {                                                                                                                                                                                                                                    
                // reduce the timer bar width                                                                                                                                                                                                                  
                var widthPercentage = Math.round(time*100/(gameNextDelay*10));                                                                                                                                                                                 
                var widthText = 'width: ' + widthPercentage + '%';                                                                                                                                                                                             
                timerBar.setAttribute("style", widthText);                                                                                                                                                                                                     
             } else {                                                                                                                                                                                                                                          
                // set timer bar width to 0 and exit                                                                                                                                                                                                           
                timerBar.setAttribute("style", "width: 0%");                                                                                                                                                                                                   
                clearInterval(timer);                                                                                                                                                                                                                          
             }                                                                                                                                                                                                                                                 
          }, 100);                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
          // hide the flash card after (x) delay depending on config                                                                                                                                                                                           
          setTimeout(() => remove_flash_card(gameCard), (gameNextDelay*1000)+500);                                                                                                                                                                             
                                                                                                                                                                                                                                                               
          // is this the last and final question??                                                                                                                                                                                                             
          if(i===questions.length-1){                                                                                                                                                                                                                          
            // this is the end! some clean up and then display results                                                                                                                                                                                         
            setTimeout(function(){                                                                                                                                                                                                                             
              recognizer.stopListening(); // stop teacheable machine                                                                                                                                                                                           
              document.getElementById("timer-progress-bar").remove();                                                                                                                                                                                          
              document.getElementById("flash-card").remove();                                                                                                                                                                                                  
              let stopGameMusic = document.getElementById("background-sound");                                                                                                                                                                                 
              if(stopGameMusic){ stopGameMusic.pause(); }                                                                                                                                                                                                      
              let playEndSound = document.getElementById("game-end-sound");                                                                                                                                                                                    
              if(playEndSound){                                                                                                                                                                                                                                
                playEndSound.volume = 0.5;                                                                                                                                                                                                                     
                playEndSound.play();                                                                                                                                                                                                                           
              }                                                                                                                                                                                                                                                
              let showEndMessage = document.getElementById("end-message");                                                                                                                                                                                     
              showEndMessage.classList.add("scale-in");                                                                                                                                                                                                        
              return false;                                                                                                                                                                                                                                    
            }, (gameNextDelay*1000)+500);                                                                                                                                                                                                                      
          }                                                                                                                                                                                                                                                    
      }, (gameNextDelay+1)*1000, questions.length);                                                                                                                                                                                                            
    }                                                                                                                                                                                                                                                          
    init();                                                                                                                                                                                                                                                    
    })                                                                                                                                                                                                                                                         
  </script>                                                                                                                                                                                                                                                    
</body>                                                                                                                                                                                                                                                        
</html>                                                                                                                                                                                                                                                        